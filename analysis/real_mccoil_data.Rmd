---
title: "REAL McCOIL Data"
author: "Aris Paschalidis"
date: "`r format(Sys.time(), '%B %Y')`"
output:
  html_document:
    highlight: pygments
    toc: true
    toc_float: true
    number_sections: true
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
# Here, we set default options for our markdown file
knitr::opts_chunk$set(
  comment = "#>"
)
# Change the way tibble prints so only prints 5 extra columns
options(tibble.max_extra_cols = 5)

# Function to determine if pbapply is installed. If it is installed, it will
# display a progress bar
list_apply <- function(x, fun, ...){
  if (requireNamespace("pbapply", quietly = TRUE)) {
    pbapply::pblapply(x, fun, ...)
    } else {
    lapply(x, fun, ...)
  }
}

# Define booleans to determine whether certain code chunks should be run.
run_real = FALSE
read_pf3k = FALSE

library(coiaf)
library(ggplot2)
```

In this analysis file, we run our COI algorithm on a collection of real data
obtained from the Pf3k Malaria project. Additionally, we compare the results of
our algorithm with the current state of the art model for predicting COI -- REAL
McCOIL.

# Run Real Data

```{r read data, eval = run_real}
# Path to data
path = "~/Desktop/Malaria/COI data/"

# Read in the real data and the REAL McCOIL COI predictions
rmcl_wsafs   <- readRDS(paste0(path, "RMCL_wsafs_unique.rds"))
rmcl_coi_out <- readRDS(paste0(path, "RMCL_coi_out.rds")) %>% 
  tibble::as_tibble() %>% 
  dplyr::mutate(dplyr::across(c(file, name), as.character)) %>% 
  dplyr::rename(rmcl = COI) %>% 
  dplyr::rename(rmcl_025 = COI_025) %>% 
  dplyr::rename(rmcl_975 = COI_975)
```

Run our data, set it up in an ideal format and save the data sets as .rds files

```{r run data, eval = run_real}
raw_predictions <- list_apply(seq_len(length(rmcl_wsafs)), function(x) {
  # Run predictions
  sample <- rmcl_wsafs[[x]]
  predicted <- run_real_data(sample)

  # Extract coi from the predictions
  extract_coi <- tibble::enframe(unlist(lapply(predicted, function(x){ x$coi })),
                                 value = "prediction") %>%
    dplyr::mutate(file = names(rmcl_wsafs)[x])

  # Summarize over the 5 rmcl runs
  rmcl_outputs <- rmcl_coi_out %>%
    dplyr::filter(stringr::str_detect(file, names(rmcl_wsafs)[x])) %>%
    dplyr::group_by(name) %>%
    dplyr::summarise(rmcl = mean(rmcl),
                     rmcl_median = median(rmcl),
                     rmcl_025 = mean(rmcl_025),
                     rmcl_975 = mean(rmcl_975),
                     .groups = "drop")

  # Join the tibbles and find difference
  res <- dplyr::full_join(extract_coi, rmcl_outputs, by = "name")
  return(res)
})
names(raw_predictions) <- names(rmcl_wsafs)

# Set up a tibble with all the information from the runs
complete_predictions <- raw_predictions %>%
  dplyr::bind_rows() %>% 
  dplyr::mutate(difference_mean = prediction - rmcl) %>% 
  dplyr::mutate(difference_median = prediction - rmcl_median) %>%
  dplyr::mutate(in_CI = ifelse(prediction >= rmcl_025 & 
                                 prediction <= rmcl_975, 1, 0)) %>%
  dplyr::mutate(Region = as.numeric(stringr::str_extract(file, "(?<=region_)[:digit:]*"))) %>% 
  dplyr::mutate(VCF = as.numeric(stringr::str_extract(file, "(?<=vcf_)[:digit:]*"))) %>% 
  dplyr::relocate(file, .after = tidyselect::last_col())

# Save data
saveRDS(raw_predictions, file = "analysis/rmcl_raw_predictions.rds")
saveRDS(complete_predictions, file = "analysis/rmcl_complete_predictions.rds")
```

```{r load data, eval = !run_real, include = FALSE}
raw_predictions <- readRDS("rmcl_raw_predictions.rds")
complete_predictions <- readRDS("rmcl_complete_predictions.rds")
```

# Evaluate Our Predictions

Plot the results looking at COI and comparison to REAL McCOIL.

```{r predicted COI plot}
ggplot(complete_predictions, aes(factor(prediction), 
                                 fill = factor(prediction))) +
  geom_bar(stat = "count") + 
  facet_wrap(. ~ Region, nrow = 4, scales = "free", labeller = "label_both") + 
  ggsci::scale_fill_d3() +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, size = 13),
        axis.title = element_text(size = 10)) +
  guides(fill = FALSE) +
  labs(x = "Predicted COI", y = "Count", title = "Predicted COI in Each Region")
```

```{r mean coiaf vs REAL McCOIL}
ggplot(na.omit(complete_predictions), aes(factor(difference_mean), 
                                          fill = factor(difference_mean))) +
  geom_bar(stat = "count") + 
  facet_wrap(. ~ Region, nrow = 4, scales = "free", labeller = "label_both") + 
  theme_classic() +
  theme(plot.title  = element_text(hjust = 0.5, size = 13),
        axis.title = element_text(size = 10)) +
  guides(fill = FALSE) +
  labs(x = "Difference Between coiaf And REAL McCOIL Mean", y = "Count", 
       title = "Difference Between coiaf And REAL McCOIL Mean By Region")
```

```{r median coiaf vs REAL McCOIL}
ggplot(na.omit(complete_predictions), aes(factor(difference_median), 
                                          fill = factor(difference_median))) +
  geom_bar(stat = "count") + 
  facet_wrap(. ~ Region, nrow = 4, scales = "free", labeller = "label_both") + 
  theme_classic() +
  theme(plot.title  = element_text(hjust = 0.5, size = 13),
        axis.title = element_text(size = 10)) +
  guides(fill = FALSE) +
  labs(x = "Difference Between coiaf And REAL McCOIL Median", y = "Count", 
       title = "Difference Between coiaf And REAL McCOIL Median By Region")
```

## Incorrect Trends
Why does our model get samples wrong?

```{r, eval = FALSE}
incorrect <- complete_predictions %>% 
  dplyr::filter(prediction != rmcl) %>% 
  dplyr::distinct(name, .keep_all = TRUE)

# Diff <= -3
minoff <- incorrect %>% 
  dplyr::filter(difference_median <= -3) %>% 
  dplyr::arrange(prediction)
par(mfrow = c(5,4))
for (i in 1:nrow(minoff)){
  file = minoff$file[i]
  name = minoff$name[i]
  plot(rmcl_wsafs[[file]][name,], pch = 20, cex = 0.5, 
      ylim = c(0,1), ylab = "WSAF", 
      main = paste0(name, ", coiaf = ", minoff[i,]$prediction, ", rmcl = ", minoff[i,]$rmcl))
}

# Diff -2
minoff <- incorrect %>% 
  dplyr::filter(difference_median == -2) %>% 
  dplyr::arrange(prediction)
for (i in 1:nrow(minoff)){
  if (i %% 36 == 1){ 
    png(paste0("~/Desktop/Images for OJ-Jeff/diff-2/diff2set", i, ".png"), 
        width = 1500, height = 1500)
    par(mfrow = c(6,6)) }
  file = minoff$file[i]
  name = minoff$name[i]
  plot(rmcl_wsafs[[file]][name,], pch = 20, cex = 0.5, 
      ylim = c(0,1), ylab = "WSAF", 
      main = paste0(name, ", coiaf = ", minoff[i,]$prediction, ", rmcl = ", minoff[i,]$rmcl))
  if (i %% 36 == 0) { dev.off() }
}

# Diff -1
minoff <- incorrect %>% 
  dplyr::filter(difference_median == -1) %>% 
  dplyr::arrange(prediction)
for (i in 1:nrow(minoff)){
  if (i %% 49 == 1){ 
    png(paste0("~/Desktop/Images for OJ-Jeff/diff-1/diff1set", i, ".png"), 
        width = 1500, height = 1500)
    par(mfrow = c(7,7)) }
  file = minoff$file[i]
  name = minoff$name[i]
  plot(rmcl_wsafs[[file]][name,], pch = 20, cex = 0.5, 
      ylim = c(0,1), ylab = "WSAF", 
      main = paste0(name, ", coiaf = ", minoff[i,]$prediction, ", rmcl = ", minoff[i,]$rmcl))
  if (i %% 49 == 0) { dev.off() }
}

# Diff > -1
minoff <- incorrect %>% 
  dplyr::filter(difference_median > -1) %>% 
  dplyr::arrange(prediction)
for (i in 1:nrow(minoff)){
  if (i %% 49 == 1){ 
    png(paste0("~/Desktop/Images for OJ-Jeff/diffg-1/diffg1set", i, ".png"), 
        width = 1500, height = 1500)
    par(mfrow = c(7,7)) }
  file = minoff$file[i]
  name = minoff$name[i]
  plot(rmcl_wsafs[[file]][name,], pch = 20, cex = 0.5, 
      ylim = c(0,1), ylab = "WSAF", 
      main = paste0(name, ", coiaf = ", minoff[i,]$prediction, ", rmcl = ", minoff[i,]$rmcl))
  if (i %% 49 == 0) { dev.off() }
}
```


# World Maps

## Pf3k Data

We need to access the Pf3k data in order to create a world map. 

```{r read Pf3k, eval = read_pf3k}
# Read in
tf <- tempfile()
download.file("ftp://ngs.sanger.ac.uk/production/malaria/pfcommunityproject/Pf6/Pf_6_samples.txt",tf)
meta <- data.table::fread(tf)
saveRDS(meta, file = "analysis/pf3k_meta.rds")
```

```{r load Pf3k, eval = !read_pf3k, include = FALSE}
meta <- readRDS("pf3k_meta.rds")
```

We can then cluster our samples into suitably close regions, for which we assume
the same PLAF exists but without reducing our n. We can use a silhouette plot to 
visualize the optimum number of regions to guide our decisions.

```{r k-means}
# K Means
locations <- unique(meta[, c("Lat", "Long")])

sis <- 2:(nrow(locations) - 1)
for(k in sis) {
  si <- cluster::silhouette(cluster::pam(x = locations, k))
  sis[k - 1] <- mean(si[, 3])
}

plot(sis)
abline(v = which(diff(sign(diff(sis))) == -2) + 1)
text(which(diff(sign(diff(sis))) == -2) + 2, 0.1, 
     which(diff(sign(diff(sis)))== -2) + 2)
```

Based on this plot, we select 24 regions as the optimal cluster number. We then
cluster our samples and combine the data with our predictions.

```{r cluster}
# Clustering with 24 locations
ks <- cluster::pam(meta[,c("Lat","Long")], k = 24)
meta$color <- as.factor(ks$clustering)

# Combine Pf3k and our predictions
patient_lat_long <- dplyr::left_join(complete_predictions, meta, 
                                     by = c("name" = "Sample")) 
```

## Plotting

World map with average COI

```{r world map, fig.height = 2}
# Get average of data
map_average <- patient_lat_long %>% 
  dplyr::group_by(color) %>% 
  dplyr::summarise(lat = mean(Lat),
                   long = mean(Long), 
                   coi_mean = mean(prediction),
                   coi_med = median(prediction), .groups = "drop")

# Plot the mean COI (theme is added so that there is less whitespace)
world_map(map_average, map_average$coi_mean, label = "Mean COI", 
          alpha = 1, breaks = c(1.0, 1.5, 2.0, 2.5, 3.0)) + 
  theme(plot.margin = unit(c(-1, 0, -1, 0), "null"))

# Plot the median COI (theme is added so that there is less whitespace)
world_map(map_average, map_average$coi_med, label = "Median COI", 
          alpha = 1, breaks = c(1.0, 1.5, 2.0)) + 
  theme(plot.margin = unit(c(-0.9, 0, -0.9, 0), "null"))
```

World map with all data

```{r all patients map, fig.height = 2}
# Get data that has a COI of less than 10. This is done for now as we suspect
# there are some samples that are wrong! Regions that predict 25! 
# We also set up data to be descending so that smaller COIs stay on top.
all_world_map <- patient_lat_long %>% 
  dplyr::filter(prediction <= 10) %>% 
  dplyr::arrange(desc(prediction)) %>% 
  dplyr::rename(lat = Lat) %>% 
  dplyr::rename(long = Long)

# Plot all patient COIs (theme is added so that there is less whitespace)
world_map(all_world_map, all_world_map$prediction, "COI", 
          breaks = c(1, 2, 4, 6, 8, 10))
```

