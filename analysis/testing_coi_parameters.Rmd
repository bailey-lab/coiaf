---
title: "Testing COI Parameters"
author: "Aris Paschalidis"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    highlight: pygments
    toc: true
    toc_float: true
    number_sections: true
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 80)
  eval = FALSE
)

library(coiaf)
```

In this analysis file, we aim to understand the effect of varying parameters on
our COI framework. The parameters that we will examine are:

* COI_range: A number indicating the range of COIs to compare the simulated 
data to.
* method: The method to be employed. One of "end", "ideal", "overall".
* dist_method: The distance method used to determine the distance between the 
theoretical and simulated curves for the "overall" method. One of "abs_sum", 
"sum_abs", "squared", "KL".
* weighted: An indicator indicating whether to compute weighted distance.
* coverage: Coverage at each locus.
* alpha: Shape parameter of the symmetric Dirichlet prior on strain proportions.
* overdispersion: The extent to which counts are over-dispersed relative to the 
binomial distribution. Counts are Beta-binomially distributed, with the beta 
distribution having shape parameters $p/overdispersion$ and 
$(1-p)/overdispersion$.
* epsilon: The probability of a single read being miscalled as the other allele.
Applies in both directions.
* seq_error: The level of sequencing error that is assumed.

#### Setting our PLAF
```{r}
# Set the seed
set.seed(1)

# Define number of loci, and distribution of minor allele frequencies
L <- 1e3
p <- rbeta(L, 1, 5)
p[p > 0.5] <- 1 - p[p > 0.5]
```

## COI
We first want to understand for what range our model can accurately predict
the COI.

```{r}
tcoi <- coi_test(COI = 2:40, repetitions = 100,
                 PLAF = p, method = "overall", dist_method = "squared")

sensitivity_plot(data = tcoi, plot_dims = c(1, 1), title = "COI")

#N.B. to save the plots, we can use g
# %>% ggpubr::ggexport(filename = "~/Desktop/Images/tdistance.pdf")
```

Based on the above set of runs, it appears that the algorithm performs well for
a very large range of COIs. We see that as the true COI increases, the error
and bias likewise increase. However, even at a COI of 40, the error and bias are
small, at roughly 4 and -4, respectively. It is interesting to note that our
bias is always negative. This indicates that the algorithm consistently 
underpredicts the COI.

The fact that our model struggles with larger COIs makes sense as at that point,
the theoretical COI curves are essentially identical. Although it is remarkable
that the algorithm performs this well at COIs that large, COIs of greater than 
20 are somehwat unrealistic. For the rest of this document, we only consider 
COIs of 2 till 20.

## COI Range
```{r}
tcoi_range <- coi_test(COI = 2:20, COI_range = 10:21, repetitions = 100,
                 PLAF = p, method = "overall", dist_method = "squared")

sensitivity_plot(data = tcoi_range, 
                 plot_dims = c(4, 3), 
                 change_param = "COI Range = ",
                 change_param_val = 10:21)
```

As expected, the lower the COI range, the lower the error and bias. This makes
intuitive sense as the COI_range allows us to determine how many theoretical
COI values we will test to see which our simulated data is closest to. The fact
that our model works well with large `COI_range` values is promising and implies
that our model can accurately compute the COI.

## Method
```{r}
tmethod <- coi_test(COI = 2:20, PLAF = p, dist_method = "squared", 
                 repetitions = 100)

sensitivity_plot(data = tmethod,
                 plot_dims = c(3, 1),
                 change_param = "Method = ",
                 change_param_val = c("End", "Ideal", "Overall"))
```


## Distance Method
```{r}
tdistance <- coi_test(COI = 2:20, PLAF = p, method = "overall", 
                      repetitions = 100)

sensitivity_plot(data = tdistance,
                 plot_dims = c(2, 2),
                 change_param = "Distance Method = ",
                 change_param_val = c("Absolute Sum", "Sum of Absolute",
                                      "Squared Error", "KL Divergence"))
```

## Weighted
```{r}
tweight <- coi_test(COI = 2:20, weighted = c(FALSE, TRUE),
                 PLAF = p, method = "overall", repetitions = 100)

sensitivity_plot(data = tweight,
                 plot_dims = c(2, 4),
                 change_param_val = 
                   paste(rep(c("Abs Sum", "Sum Abs", 
                                "Squared", "KL"), 2),
                          rep(c("Not Weighted", "Weighted"), each = 4)))
```

## Coverage
```{r}
tcoverage <- coi_test(COI = 2:20, coverage = c(25, 50, 100, 200, 400, 800), 
                 repetitions = 100, PLAF = p,
                 method = "overall", dist_method = "squared")

sensitivity_plot(data = tcoverage,
                 plot_dims = c(2, 3),
                 change_param = "Coverage = ",
                 change_param_val = c(25, 50, 100, 200, 400, 800))
```

## Alpha
```{r}
talpha <- coi_test(COI = 2:20, alpha = seq(0.01, 5.51, 0.5), 
                 repetitions = 100, PLAF = p, 
                 method = "overall", dist_method = "squared")

sensitivity_plot(data = talpha,
                 plot_dims = c(4, 3),
                 change_param = "Alpha = ",
                 change_param_val = seq(0.01, 5.51, 0.5))
```

## Overdispersion
```{r}
tover <- coi_test(COI = 2:20, overdispersion = seq(0, 0.2, 0.05), 
                 repetitions = 100, PLAF = p, 
                 method = "overall", dist_method = "squared")

sensitivity_plot(data = tover,
                 plot_dims = c(3, 2),
                 change_param = "Overdispersion = ",
                 change_param_val = seq(0, 0.2, 0.05))
```

When you introduce overdispersion, models perform poorly. If you introduce 0.1, 
models do not perform terribly. What is the cutoff here? How much overdispersion
can we introduce?

## Epsilon
```{r}
tepsilon <- coi_test(COI = 2:20, epsilon = seq(0, 1, 0.1), 
                 repetitions = 100, PLAF = p, 
                 method = "overall", dist_method = "squared")

sensitivity_plot(data = tepsilon,
                 plot_dims = c(4, 3),
                 change_param = "Epsilon = ",
                 change_param_val = seq(0, 1, 0.1))
```

## Sequencing Error
```{r}
tseq <- coi_test(COI = 2:20, seq_error = seq(0, 0.22, 0.02), 
                 repetitions = 100, PLAF = p, 
                 method = "overall", dist_method = "squared")

sensitivity_plot(data = tseq,
                 plot_dims = c(4, 3),
                 change_param = "Sequence Error = ",
                 change_param_val = seq(0, 0.22, 0.02))
```
